<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Operador - Chamada de Senhas</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
    #painel { font-size: 5em; margin: 20px 0; }
    #guicheTxt { font-size: 2em; margin: 10px 0; }
    .controls { margin: 20px 0; }
    input, button { font-size: 1.2em; margin: 5px; padding: 5px 10px; }
  </style>
</head>
<body>
  <h1>Operador - Chamada de Senhas</h1>

  <div id="painel">
    <div id="senhaBig">A-000</div>
    <div id="guicheTxt">Dirija-se ao guichÃª 1</div>
  </div>

  <div class="controls">
    Prefixo: <input id="prefix" value="A" maxlength="1">
    NÃºmero: <input id="numero" type="number" value="0" readonly>
    GuichÃª: <input id="guiche" value="1">
    <button onclick="next()">PrÃ³xima senha (N)</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, onValue, set, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    // ðŸ”‘ ConfiguraÃ§Ã£o do Firebase (substitua pelos seus dados)
    const firebaseConfig = {
      apiKey: "AIzaSyDPcPaWLF4dxQ_091qiru1w9HXS05rtcz8",
      authDomain: "fila-atendimento.firebaseapp.com",
      databaseURL: "https://fila-atendimento-default-rtdb.firebaseio.com",
      projectId: "fila-atendimento",
      storageBucket: "fila-atendimento.firebasestorage.app",
      messagingSenderId: "813517035677",
      appId: "1:813517035677:web:caa3fedeac9719ff009c74"
    };

    // Inicializa Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // Estado local
    const state = { prefix: "A", number: 0, guiche: "1", ts: Date.now() };

    // Elementos da pÃ¡gina
    const el = {
      senhaBig: document.getElementById("senhaBig"),
      guicheTxt: document.getElementById("guicheTxt"),
      prefix: document.getElementById("prefix"),
      numero: document.getElementById("numero"),
      guiche: document.getElementById("guiche"),
    };

    const pad = n => String(n).padStart(3, "0");

    function updateDisplay() {
      el.senhaBig.textContent = `${state.prefix}-${pad(state.number)}`;
      el.guicheTxt.textContent = `Dirija-se ao guichÃª ${state.guiche}`;
      el.prefix.value = state.prefix;
      el.numero.value = state.number;
      el.guiche.value = state.guiche;
    }

    // ReferÃªncia principal no Firebase
    const stateRef = ref(db, "fila/state");

    // Escuta atualizaÃ§Ãµes em tempo real
    onValue(stateRef, (snapshot) => {
      if (snapshot.exists()) {
        Object.assign(state, snapshot.val());
        updateDisplay();
      }
    });

    // Atualiza prefixo e guichÃª no Firebase
    el.prefix.addEventListener("input", () => {
      state.prefix = el.prefix.value;
      set(stateRef, { ...state, ts: Date.now() });
    });

    el.guiche.addEventListener("input", () => {
      state.guiche = el.guiche.value;
      set(stateRef, { ...state, ts: Date.now() });
    });

    // Incrementa nÃºmero de forma segura (sem conflito entre operadores)
    function next() {
      const numRef = ref(db, "fila/state/number");

      runTransaction(numRef, (current) => {
        return (current || 0) + 1;
      }).then(() => {
        // Atualiza outros campos (prefixo e guichÃª)
        set(stateRef, {
          prefix: state.prefix,
          number: state.number, // atualizado automaticamente pelo onValue
          guiche: state.guiche,
          ts: Date.now()
        });
      }).catch((err) => {
        console.error("Erro ao avanÃ§ar senha:", err);
      });
    }

    // Atalho no teclado (tecla "N")
    window.addEventListener("keydown", (e) => {
      if (e.key.toLowerCase() === "n") next();
    });

    updateDisplay();

    // Login automÃ¡tico do operador (ajuste usuÃ¡rio/senha no Firebase Auth)
    signInWithEmailAndPassword(auth, "operador@empresa.com", "SENHA_FORTE")
      .then(userCred => {
        console.log("Operador logado:", userCred.user.uid);
      })
      .catch(err => {
        alert("Erro de login: " + err.message);
      });
  </script>
</body>
</html>
